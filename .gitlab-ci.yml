workflow:
  rules:
    - if: $CI_COMMIT_MESSAGE =~ / \[no-ci\]/
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - when: always

stages:
  - lint
  - test
  - deploy

lint:
  stage: lint
  image: python:3.8.7-slim
  tags:
    - docker_dio
  script:
    - apt update
    - apt install git -y
    - pip install pre-commit
    - pre-commit run --all-files

test:
  stage: test
  image: python:3.8.7
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  only:
    changes:
      - kanon/**/*
  cache:
    paths:
      - .cache/pip
  tags:
    - docker_dio
  script:
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    - source $HOME/.poetry/env
    - poetry install
    - poetry run tox -e test-cov -- --junitxml={toxinidir}/report.xml
  artifacts:
    reports:
      junit: report.xml
      cobertura: coverage.xml

test_notebooks:
  stage: test
  image: python:3.8.7
  tags:
    - docker_dio
  allow_failure: true
  only:
    changes:
      - kanon/**/*
      - examples/**/*
  script:
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    - source $HOME/.poetry/env
    - poetry install --extras notebook
    - poetry run tox -e test_notebooks

deploy:testpypi:
  stage: deploy
  image: python:3.8.7
  variables:
    TWINE_PASSWORD: $TWINE_PASSWORD_TESTPYPI
  tags:
    - docker_dio
  when: manual
  only:
    - tags
  script:
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    - source $HOME/.poetry/env
    - pip install poetry-dynamic-versioning
    - poetry config repositories.pypitest https://test.pypi.org/legacy/
    - poetry config pypi-token.pypitest $TWINE_PASSWORD
    - poetry publish --repository testpypi --build

deploy:pypi:
  stage: deploy
  image: python:3.8.7
  variables:
    POETRY_PYPI_TOKEN_PYPI: $TWINE_PASSWORD_PYPI
  tags:
    - docker_dio
  when: manual
  only:
    - tags
  script:
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    - source $HOME/.poetry/env
    - pip install poetry-dynamic-versioning
    - poetry publish --build
